
[TOC]

##  **Creating a MapView and Waypoint Application<br>创建 MapView 和 Waypoint APP**

2018-01-15v4.4.1 4.4.1Github

If you come across any mistakes or bugs in this tutorial, please let us know using a Github issue, a post on the DJI forum. Please feel free to send us Github pull request and help us fix any issues.
如果您在本教程中遇到任何错误或BUG, 请在 Github上让我们知道或者DJI 论坛上的一个帖子。请随时发送 Github 请求, 并帮助我们解决任何问题。

In this tutorial, you will learn how to implement the DJIWaypoint Mission feature and get familiar with the usages of MissionControl. Also you will know how to test the Waypoint Mission API with DJI Assistant 2 Simulator too. So let's get started!
在本教程中, 您将学习如何实现 DJIWaypoint mission的功能, 并熟悉 MissionControl 的用法。同时你也会学到如何使用 DJI 助手2模拟器来测试 Waypoint Mission API。 让我们开始吧！

You can download the tutorial's final sample project from this Github Page.
您可以从这个 Github 页面下载教程的完整示例项目。

Note: In this tutorial, we will use Mavic Pro for testing, use Android Studio 2.1.1 for developing the demo application, and use the Gaode Map API for navigating.
注意: 在本教程中, 我们将使用 Mavic Pro 进行测试, 使用 Android Studio 2.1.1开发并演示APP, 并使用 高德 地图 API 来导航。

###  **Preparation<br>准备工作**

* * * * *

####  **Download the SDK<br>下载 SDK**
 
You can download the latest Android SDK from here: https://developer.dji.com/mobile-sdk/downloads.
你可以从这里下载最新的 Android SDK: https: / / developer.dji.com / mobile-SDK / downloads。

#### **Setup Android Development Environment<br>安装 Android 开发环境**
 
 
Throughout this tutorial we will be using Android Studio 3.0, which you can download from here: http://developer.android.com/sdk/index.html.
在本教程中, 我们将使用 Android Studio 3.0, 你可以在这里下载: http: / / developer.Android.com / sdk / index.html。

###   **Application Activation and Aircraft Binding in China<br>中国APP激活与无人机绑定**
 
* * * * *

For DJI SDK mobile application used in China, it's required to activate the application and bind the aircraft to the user's DJI account.
对于中国使用的 DJI SDK APP, 需要激活APP并将无人机绑定到用户的 DJI 帐户。

If an application is not activated, the aircraft not bound (if required), or a legacy version of the SDK (< 4.1) is being used, all camera live streams will be disabled, and flight will be limited to a zone of 100m diameter and 30m height to ensure the aircraft stays within line of sight.
如果一个APP没有被激活, 无人机不受管制(如果需要) , 或 SDK (4.1)的历史版本, 所有摄像头视频流都将被禁用, 飞行范围将限制在100米直径和30米高度范围内, 以确保无人机保持在视线范围内。

To learn how to implement this feature, please check this tutorial Application Activation and Aircraft Binding.
要学习如何实现这一功能, 请检查教程 APP激活和无人机绑定。

###  **Implementing the UI of Application<br>实现APP界面**
 
* * * * *

We can use the map view to display waypoints and show the flight route of the aircraft when waypoint mission is being executed. Here, we take Gaode Map for an example.
我们可以使用地图来显示航点, 并在执行 waypoint 任务时显示无人机的飞行路线。在这里, 我们以高德地图为例。

####  **Configurating AMAP API Key<br>配置 AMAP API 密钥**
 
##### **1. Create the project<br>1. 创建项目**

Open Android Studio and select File -> New -> New Project to create a new project, named "GSDemo". Enter the company domain and package name (Here we use "com.dji.GSDemo.GaodeMap") you want and press Next. Set the mimimum SDK version as API 19: Android 4.4 (KitKat) for "Phone and Tablet" and press Next. Then select "Empty Activity" and press Next. Lastly, leave the Activity Name as "MainActivity", and the Layout Name as "activity_main", Press "Finish" to create the project.
打开android studio并选择File-New-New Project 创建一个名为"GSDemo"的新项目。 输入您想要的公司域名和包名(这里我们使用"com.dji.GSDemo.GaodeMap")并按下一步。 将 mimimum SDK 版本设置为 API 19: Android 4.4(KitKat) , 用于"手机和平板电脑"并按下一步。 然后选择"空活动"并按下一步。 最后, 将Activity name命名为"MainActivity", 并将"layout_name"命名为"activity_main", 按"完成"来创建项目。

  **2. Generating SHA-1 Key<br>2 生成 SHA-1值** 
 
We can use Android Studio to generate a SHA-1 Key easily. Click on the Gradle tap on the right side of Android Studio. Select the project and navigate to Tasks -> android -> signingReport.
我们可以使用 Android Studio生成一个 SHA-1键。 点击android studio右侧的 Gradle tap。 选择项目并导航到任务-android-signingReport。
![](https://devcn.djicdn.com/images/tutorials-and-samples/Android/GSDemo-Gaode-Map/signingReport-729e1e4389.png)
signingReport

Then double click the signingReport and check the Console area of Android Studio, you can find the SHA-1 key easily:
然后双击android studio的signingReport并检查控制台区域, 你可以很容易地找到 SHA-1值:
![](https://devcn.djicdn.com/images/tutorials-and-samples/Android/GSDemo-Gaode-Map/SHA-1Key-80119474ac.png)
SHA1

 **3. Applying for an AMAP Key<br>3. 申请 AMAP KEY** 
 
Now, let's go to AMAP Developer Platform to apply for an AMAP Key. If it's your first time go to this website, please register first. Then login with your amap account and press the "+创建新应用" button on the upper right corner. Enter your application's name and press "创建" to continue. You will see the following screenshot here:
现在, 让我们去 AMAP 开发平台申请 AMAP KEY。首次访问网站时, 请先注册。 然后用你的 amap 账户登录, 然后按右上角的"+"按钮。 输入您的APP的名称, 并按"创建"继续。 你可以在这里看到下面的截图:
![](https://devcn.djicdn.com/images/tutorials-and-samples/Android/GSDemo-Gaode-Map/createApplication-92e0a93991.png)
createApplication

Next, click the "添加新Key" button on the upper right corner of "GSDemo" Application. Enter the info as you want, for the "发布版安全码：SHA1" and "调试版安全码SHA1" fields, please enter the SHA-1 key we just generate in the above steps.
接下来, 请点击"GSDemo"APP右上角的"添加新 key"按钮。 如果你想输入信息, 请输入我们刚刚在上面的步骤中生成的 SHA-1值。
![](https://devcn.djicdn.com/images/tutorials-and-samples/Android/GSDemo-Gaode-Map/createAMAPKey-9bd24e39a6.png)
createAMAPKey

Note: The "Package" should be the same to your Android project's Package name.
注意:"Package"应该与你的 Android 项目的包名称相同。

Moreover, press "提交" and you can get your AMAP Key like this:

此外, 按下"AMAP"键, 你就可以得到这样的 AMAP KEY:
![](https://devcn.djicdn.com/images/tutorials-and-samples/Android/GSDemo-Gaode-Map/amapKey-9f4f6d00f8.png)
AMAPKey

 **4. Adding AMAP Key<br>4. 添加 AMAP KEY**
 
Open the AndroidManifest.xml file, add the following elements as childs of element and substitute your AMAP Key for "YOUR _ AMAP_KEY" in the value attribute as shown below:
打开 AndroidManifest.xml 文件, 用AMAP KEY替换YOUR _ AMAP_KEY, 如下所示:
~~~
<!-- 启用高德地图服务 -->
<meta-data
    android:name="com.amap.api.v2.apikey"
    android:value="YOUR_AMAP_KEY" />
This will set the key "com.amap.api.v2.apikey" to the value of your AMAP key.
~~~
Next, specify the permissions of your application needs, by adding <uses-permission> elements as children of the <manifest> element in the "AndroidManifest.xml" file.
接下来, 通过添加"AndroidManifest.xml"文件中的权限清单, 指定APP需要的权限。
~~~
<uses-permission android:name="android.permission.BLUETOOTH" />
<uses-permission android:name="android.permission.BLUETOOTH_ADMIN" />
<uses-permission android:name="android.permission.INTERNET" />
<uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />
<uses-permission android:name="android.permission.READ_PHONE_STATE" />
<uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />
<uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION" />
<uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
<uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
<uses-permission android:name="android.permission.CHANGE_WIFI_STATE" />
<uses-permission android:name="android.permission.ACCESS_WIFI_STATE" />
<uses-permission android:name="android.permission.CHANGE_CONFIGURATION" />
<uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW" />
<uses-permission android:name="android.permission.WRITE_SETTINGS" />
<uses-permission android:name="android.permission.VIBRATE" />
<uses-permission android:name="android.permission.WAKE_LOCK" />
<uses-permission android:name="android.permission.MOUNT_UNMOUNT_FILESYSTEMS" />
<uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
<uses-permission android:name="android.permission.ACCESS_LOCATION_EXTRA_COMMANDS" />
~~~
For more details of description on the permissions, please refer to http://lbs.amap.com/api/android-sdk/guide/create-project/dev-attention.
有关权限的详细说明, 请参阅 http: / / lbs.amap.com / api / android-sdk / guide / create-project / dev-attention。

 #### **Importing the AMAP JAR Packages<br>导入 AMAP JAR 包**
 
 
Let's go to http://lbs.amap.com/api/android-sdk/down/ to download the latest version of AMAP Android's 2D Map SDK and search service SDK as shown below:
到 http: / / lbs.AMAP.com / api / Android-SDK / down / 下载最新版本的 AMAP Android 的2D Map SDK 和搜索服务 SDK, 如下所示:
![](https://devcn.djicdn.com/images/tutorials-and-samples/Android/GSDemo-Gaode-Map/amapSDK-5fed9871fe.png)
amapSDK

Once you finish the download, copy the two SDK jar files to the libs folder of your Android Studio project: app->libs.
一旦完成下载, 将两个 SDK jar 文件复制到你的 Android studio项目的app->libs文件夹。

Then right click on the app folder in the project navigator and select "Open Module Settings" to open the "Project Structure" window.
然后右击项目导航栏中的app, 选择"open module setting"打开"Project Structure"窗口。
![](https://devcn.djicdn.com/images/tutorials-and-samples/Android/GSDemo-Gaode-Map/openModuleSettings-ec0c791454.png)

Next, press the "+" button on the upper left corner of the window and select "Import .JAR/.ARR Package", and press "Next" button. Moreover, select the amap packages in the "File name" field of the "Create New Module" window as shown below:
接下来, 在窗口的左上角点击"+", 选择"Import .jar"。 点击next。 此外, 在"create new module"窗口的"file name"中选择 amap 包, 如下所示:
![](https://devcn.djicdn.com/images/tutorials-and-samples/Android/GSDemo-Gaode-Map/selectLibsPackage-639f7e090e.png)
selectLibsPackage

Then press "Finish" button to import the AMap_2DMap JAR package:
然后按"finish"导入 AMap 2dmap JAR 包:
![](https://devcn.djicdn.com/images/tutorials-and-samples/Android/GSDemo-Gaode-Map/createNewModule-5c91177bf7.png)
createNewModule

Repeart this process again to import the AMap_Search JAR package. Wait until the Sync Gradle Files finish. If everything goes well, when you open the "build.gradle(Module: app)" file, you should see the two AMap JAR packages included in the "dependencies" part:
再次重复此步骤, 以导入 AMap 搜索 JAR 包。 等到同步 Gradle 文件完成之后。 如果一切顺利, 当打开"build.gradle (Module: app)"文件时, 您应该会看到"dependencies"部分中包含的两个 AMap JAR 包:
~~~
dependencies {
    compile fileTree(dir: 'libs', include: ['.jar'])
    testCompile 'junit:junit:4.12'
    compile 'com.android.support:appcompat-v7:23.3.0'
    compile project(':AMap_2DMap_V2.8.1_20160202')
    compile project(':AMap_Search_V3.2.1_20160308')
}

~~~
####  **Importing the Maven Dependency<br>导入 Maven 依赖**
 
You can check the Integrate SDK into Application tutorial to learn how to import the Android SDK Maven Dependency.
你可以学习Integrate SDK into Application教程,了解如何导入 Android SDK Maven 依赖项。

####  **Building the Layouts of MainActivity<br>构建 MainActivity 的布局**
 
 **1. Working on the MApplication, DJIDemoApplication and ConnectionActivity<br>1. 探究 MApplication, DJIDemoApplication 和 ConnectionActivity**

Please check the Creating an Camera Application tutorial and the sample project of this tutorial for the detailed implementations of MApplication and DJIDemoApplication.
请学习Creating an Camera Application教程和本教程的示例项目, 以详细实现 MApplication 和 DJIDemoApplication。

To improve the user experience, we had better create an activity to show the connection status between the DJI Product and the SDK, once it's connected, the user can press the OPEN button to enter the MainActivity. You can also check the Creating an Camera Application tutorial to learn how to implement the ConnectionActivity Class and Layout in this project.
为了改善用户体验, 我们最好创建一个Activity来显示 DJI 无人机和 SDK 之间的连接状态, 一旦连接, 用户可以按open进入 MainActivity。 您也可以查看Creating an Camera Application教程来学习如何在这个项目中实现 ConnectionActivity 类和布局。

 **2. Implementing the MainActivity Layout<br>实现MainActivity布局**
 
Open the activity_main.xml layout file and replace the code with the following:
打开活动 main.xml 布局文件, 并用以下代码替换:
~~~
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:tools="http://schemas.android.com/tools"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical"
    android:background="FFFFFF"
    tools:context="com.dji.GSDemo.GaodeMap.MainActivity">
    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:orientation="horizontal">
        <TextView
            android:id="@+id/ConnectStatusTextView"
            android:layout_width="wrap_content"
            android:layout_height="wrap_content"
            android:text="GSDemo"
            android:gravity="center"
            android:textColor="000000"
            android:textSize="21sp"
            />
    </LinearLayout>
    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:orientation="horizontal">
        <Button
            android:id="@+id/locate"
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:text="Locate"
            android:layout_weight="1"/>
        <Button
            android:id="@+id/add"
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:text="Add"
            android:layout_weight="1"/>
        <Button
            android:id="@+id/clear"
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:text="Clear"
            android:layout_weight="1"/>
    </LinearLayout>
    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:orientation="horizontal">
        <Button
            android:id="@+id/config"
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:text="Config"
            android:layout_weight="0.9"/>
        <Button
            android:id="@+id/upload"
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:text="Upload"
            android:layout_weight="0.9"/>
        <Button
            android:id="@+id/start"
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:text="Start"
            android:layout_weight="1"/>
        <Button
            android:id="@+id/stop"
            android:layout_width="match_parent"
            android:layout_height="wrap_content"
            android:text="Stop"
            android:layout_weight="1"/>
    </LinearLayout>
    <LinearLayout
        android:layout_width="match_parent"
        android:layout_height="match_parent"
        android:orientation="horizontal">
        <com.amap.api.maps2d.MapView
            android:id="@+id/map"
            android:layout_width="match_parent"
            android:layout_height="match_parent"/>
    </LinearLayout>
</LinearLayout>

~~~
In the xml file, we implement the following UIs:
在 xml 文件中, 我们实现了以下 UI:

Create a LinearLayout to show a TextView with "GSDemo" title and put it on the top.
创建一个线性布局, 用"GSDemo"作为标题并将其放在顶部。

Create two lines of Buttons: "LOCATE", "ADD", "CLEAR", "CONFIG", "UPLOAD", "START" and "STOP", place them horizontally.
创建两行按钮:"LOCATE","ADD","CLEAR","CONFIG","UPLOAD","START"和"STOP", 将它们水平排列。

Lastly, we create a map view fragment and place it at the bottom.
最后, 我们创建一个 mapFragment , 并将它放在底部。

Next, copy the "aircraft.png" and "ic_launcher.png" image files from this tutorial's Github sample project to the drawable folders inside the res folder.
接下来,从本教程的 Github 示例项目的 res 文件夹下的drawable文件夹,复制"aircraftt.png"和"ic launcher.png"。

Furthermore, open the AndroidManifest.xml file and update the ".MainActivity" activity element with several attributes as shown below:
此外, 打开 AndroidManifest.xml 文件, 在Mainactivity中添加以下几个属性:
~~~
<activity
            android:name=".MainActivity"
            android:configChanges="orientation|screenSize"
            android:label="@string/title_activity_mainactivity"
            android:screenOrientation="landscape"
            android:theme="@android:style/Theme.NoTitleBar.Fullscreen" >
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
</activity>

~~~
Now, if you check the "activity_main.xml" file, you should see the preview screenshot of MainActivity as shown below:
现在, 如果你检查"activity main.xml"文件,你会看到 MainActivity 的预览截图如下所示:
![](https://devcn.djicdn.com/images/tutorials-and-samples/Android/GSDemo-Gaode-Map/mainActivity-d45542c533.png)
MainActivity

Lastly, let's create a new xml file named "dialog_waypointsetting.xml" in the layout folder by right-clicking on the "layout" folder and select New->XML->Layout XML File. Then replace the code with the same file in this project's Github sample project, since the content is too much, we don't show them all here.
最后, 让我们在layout文件夹中创建一个新的 XML 文件, 命名为"dialog_waypointsetting.XML", 点击"layout"文件夹并创建新的 XML 布局文件。 然后使用Github 示例项目中相同的布局文件替换, 因为内容太多, 我们不会在这里显示所有的代码。

This xml file will help to setup a textView to enter "Altitude" and create three RadioButton Groups for selecting Speed, Action After Finished and Heading.
在这个 xml 文件中创建一个用来输入"高度"的TextView, 并创建三个 radioButton选择按钮, 用于选择速度、完成后的操作和标题。

Now, if you check the dialog_waypointsetting.xml file, you can see the preview screenshot of Waypoint Configuration Dialog as shown below:
现在, 如果你检查 dialog_Waypoint.xml 文件, 你可以看到 Waypoint 配置对话框的预览截图如下所示:
![](https://devcn.djicdn.com/images/tutorials-and-samples/Android/GSDemo-Gaode-Map/waypointConfig-7333394199.png)
MainActivity

 **3. Working on the MainActivity Class<br>3.MainActivity 类**
 
Let's come back to the MainActivity.java class, and replace the code with the following, remember to import the related classes as Android Studio suggested:
让我们回到 MainActivity.java 类, 用下面的代码替换, 记住按照 Android Studio 的建议导入相关的类:
~~~
public class MainActivity extends FragmentActivity implements View.OnClickListener, OnMapClickListener {
    protected static final String TAG = "MainActivity";
    
    private MapView mapView;
    private AMap aMap;
    
    private Button locate, add, clear;
    private Button config, upload, start, stop;
    @Override
    protected void onResume(){
        super.onResume();
    }
    @Override
    protected void onPause(){
        super.onPause();
    }
    @Override
    protected void onDestroy(){
        super.onDestroy();
    }
    /
      @Description : RETURN BTN RESPONSE FUNCTION
     /
    public void onReturn(View view){
        Log.d(TAG, "onReturn");
        this.finish();
    }
    private void initUI() {
        locate = (Button) findViewById(R.id.locate);
        add = (Button) findViewById(R.id.add);
        clear = (Button) findViewById(R.id.clear);
        config = (Button) findViewById(R.id.config);
        upload = (Button) findViewById(R.id.upload);
        start = (Button) findViewById(R.id.start);
        stop = (Button) findViewById(R.id.stop);
        locate.setOnClickListener(this);
        add.setOnClickListener(this);
        clear.setOnClickListener(this);
        config.setOnClickListener(this);
        upload.setOnClickListener(this);
        start.setOnClickListener(this);
        stop.setOnClickListener(this);
    }
    private void initMapView() {
        if (aMap == null) {
            aMap = mapView.getMap();
            aMap.setOnMapClickListener(this);// add the listener for click for amap object
        }
        LatLng shenzhen = new LatLng(22.5362, 113.9454);
        aMap.addMarker(new MarkerOptions().position(shenzhen).title("Marker in Shenzhen"));
        aMap.moveCamera(CameraUpdateFactory.newLatLng(shenzhen));
    }
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        
        setContentView(R.layout.activity_main);
        mapView = (MapView) findViewById(R.id.map);
        mapView.onCreate(savedInstanceState);
        initMapView();
        initUI();
    }
    private void showSettingDialog(){
        LinearLayout wayPointSettings = (LinearLayout)getLayoutInflater().inflate(R.layout.dialog_waypointsetting, null);
        final TextView wpAltitude_TV = (TextView) wayPointSettings.findViewById(R.id.altitude);
        RadioGroup speed_RG = (RadioGroup) wayPointSettings.findViewById(R.id.speed);
        RadioGroup actionAfterFinished_RG = (RadioGroup) wayPointSettings.findViewById(R.id.actionAfterFinished);
        RadioGroup heading_RG = (RadioGroup) wayPointSettings.findViewById(R.id.heading);
        speed_RG.setOnCheckedChangeListener(new RadioGroup.OnCheckedChangeListener(){
            @Override
            public void onCheckedChanged(RadioGroup group, int checkedId) {
                // TODO Auto-generated method stub
                Log.d(TAG, "Select Speed finish");
            }
        });
        actionAfterFinished_RG.setOnCheckedChangeListener(new RadioGroup.OnCheckedChangeListener() {
            @Override
            public void onCheckedChanged(RadioGroup group, int checkedId) {
                // TODO Auto-generated method stub
                Log.d(TAG, "Select action action");
            }
        });
        heading_RG.setOnCheckedChangeListener(new RadioGroup.OnCheckedChangeListener() {
            @Override
            public void onCheckedChanged(RadioGroup group, int checkedId) {
                // TODO Auto-generated method stub
                Log.d(TAG, "Select heading finish");
            }
        });
        new AlertDialog.Builder(this)
                .setTitle("")
                .setView(wayPointSettings)
                .setPositiveButton("Finish",new DialogInterface.OnClickListener(){
                    public void onClick(DialogInterface dialog, int id) {
                    }
                })
                .setNegativeButton("Cancel", new DialogInterface.OnClickListener() {
                    public void onClick(DialogInterface dialog, int id) {
                        dialog.cancel();
                    }
                })
                .create()
                .show();
    }
    
    @Override
    public void onClick(View v) {
        // TODO Auto-generated method stub
        switch (v.getId()) {
            case R.id.config:{
                showSettingDialog();
                break;
            }
            default:
                break;
        }
    }
    @Override
    public void onMapClick(LatLng point) {
    }
}

~~~
In the code shown above, we implement the following features:
在上面显示的代码中, 我们实现了以下特性:

1. Create MapView and AMap variables and 7 Button member variables for the UI. Then create the initUI() method to init the 7 Button variables and implement their setOnClickListener method and pass "this" as parameter.
1. 给UI创建 MapView 和 AMap 变量和7个 Button 成员变量。然后创建 initUI ()方法来初始化7个 Button 变量, 并实现它们的 setOnClickListener 方法, 传入"this"。

2. In the onCreate() method, we request several permissions at runtime to ensure the SDK works well when the compile and target SDK version is higher than 22(Like Android Marshmallow 6.0 device and API 23).
在 onCreate ()方法中, 我们在运行时请求多个权限, 以确保 SDK 在编译和目标 SDK 版本高于22(如 Android M 6.0设备和 API 23)。

3. Then invoke the initUI() method to initialize the UI. Then invoke the initMapView() method to create the MapView and add a marker of Shenzhen, China here. So when the Gaode map is loaded, you will see a blue pin tag on Shenzhen, China.
3.然后调用 initUI ()方法来初始化用户界面。然后调用 initMapView 方法来创建 MapView, 并添加一个中国深圳的Marker。因此,当地图被加载时,你会看到中国深圳的蓝色标签。

4. Implement the showSettingDialog method to show the Waypoint Configuration alert dialog and override the onClick() method to show the configuration dialog when press the Config button.
4. 实现 showSettingDialog 方法来显示 Waypoint 配置对话框, 并重写 onClick ()方法, 在按下配置按钮时显示配置对话框。

####  **Registering your Application<br>注册申请**
 
 **1. Modifying AndroidManifest file<br>1. 修改 AndroidManifest 文件**
 
After you finish the above steps, let's register our application with the App Key you apply from DJI Developer Website. If you are not familiar with the App Key, please check the Get Started.
完成上述步骤后, 让我们用从 DJI 开发者网站的APP KEY来注册我们的APP。 如果您不知道APP KEY, 请检查 Get Started。

1. Let's open the "AndroidManifest.xml" file and add the following elements to it:
1. 让我们打开"AndroidManifest.xml"文件, 并添加以下元素:
~~~
<uses-feature
    android:name="android.hardware.usb.host"
    android:required="false" />
<uses-feature
    android:name="android.hardware.usb.accessory"
    android:required="true" />
~~~
Here, because not all Android-powered devices are guaranteed to support the USB accessory and host APIs, include two elements that declares that your application uses the "android.hardware.usb.accessory" and "android.hardware.usb.host" feature.
这里, 因为并不是所有的 android 设备都支持 USB 配件和host api, 因此声明APP需要使用android.hardware.USB.access"和 android.hardware.USB.host

Then add the following elements above the MainActivity activity element:
然后在 MainActivity 上面添加以下元素:
~~~
<!-- DJI SDK -->
<uses-library android:name="com.android.future.usb.accessory" />
<meta-data
    android:name="com.dji.sdk.API_KEY"
android:value="Please enter your App Key here." />
<!-- 启用高德地图服务 -->
<meta-data
android:name="com.amap.api.v2.apikey"
android:value="YOUR_AMAP_KEY" />
        
<activity
    android:name="dji.sdk.sdkmanager.DJIAoaControllerActivity"
    android:theme="@android:style/Theme.Translucent" >
    <intent-filter>
        <action android:name="android.hardware.usb.action.USB_ACCESSORY_ATTACHED" />
    </intent-filter>
    
    <meta-data
      android:name="android.hardware.usb.action.USB_ACCESSORY_ATTACHED"
        android:resource="@xml/accessory_filter" />
</activity>
<service android:name="dji.sdk.sdkmanager.DJIGlobalService" >
</service>
<!-- DJI SDK -->
~~~
In the code above, we enter the App Key of the application in the value part of android:name="com.dji.sdk.API_KEY" attribute. For more details of the AndroidManifest.xml file, please check the Github source code of the demo project.
在上面的代码中, 我们在android:name="com.dji.sdk.API_KEY"输入APP KEY。 有关 AndroidManifest.xml 文件的更多细节, 请检查示例项目的 Github 源代码。

 **2. Implementing Registration in DJIDemoApplication and ConnectionActivity<br>2.实现 注册DJIDemoApplication 和 ConnectionActivity**
 
Since we have implemented the registration logics in the "DJIDemoApplication.java" and "ConnectionActivity.java" files previously, we don't explain the details here.
由于我们已经实现过「 DJIDemoApplication.java 」及「 ConnectionActivity.java 」中的注册逻辑, 所以我们不会在这里解释细节。

Now let's build and run the project and install it to your Android device. If everything goes well, you should see the "Register Success" textView like the following screenshot when you register the app successfully.
现在, 让我们建立并运行这个项目并把它安装到你的 Android 设备上。 如果一切顺利, 当你成功注册APP时, 你应该会看到"注册成功", 就像下面的截图一样。
![](https://devcn.djicdn.com/images/tutorials-and-samples/Android/GSDemo-Gaode-Map/registerSuccess-0ff9909330.png)
registerSuccess

For more details of the registration logics, please check the Creating an Camera Application tutorial.
有关注册的详细信息, 请点击 Creating an Camera Application 教程。

 ### **Implementing the Waypoint Mission<br>实现航线规划** 
 
* * * * *

####  **Locating Aircraft on Gaode Map<br>在高德地图上定位无人机** 

Before we implementing the waypoint mission feature, we should show the aircraft's location on Gaode Map and try to zoom in automatically to view the surrounding area of the aircraft.
在我们实现 waypoint 任务之前, 我们应该在高德地图上显示无人机的位置, 并尝试自动缩放以查看无人机周围的区域。

Let's open MainActivity.java file and declare the following variables first:
让我们打开 MainActivity.java 文件, 首先声明以下变量:
~~~
private double droneLocationLat = 181, droneLocationLng = 181;
private Marker droneMarker = null;
private FlightController mFlightController;
~~~
Then, since we need to detect the product connection status, we should register a BroadcastReceiver in the onCreate() method and override the onReceive() method of it as shown below:
然后, 由于我们需要知道无人机连接状态, 我们应该在 onCreate ()方法中注册 BroadcastReceiver, 并重写 onReceive ()方法, 如下所示:
~~~
@Override
protected void onDestroy(){
    super.onDestroy();
    unregisterReceiver(mReceiver);
}
@Override
protected void onCreate(Bundle savedInstanceState) {
    super.onCreate(savedInstanceState);
    setContentView(R.layout.activity_main);
    IntentFilter filter = new IntentFilter();
    filter.addAction(DJIDemoApplication.FLAG_CONNECTION_CHANGE);
    registerReceiver(mReceiver, filter);
    mapView = (MapView) findViewById(R.id.map);
    mapView.onCreate(savedInstanceState);
    initMapView();
    initUI();
}
    
protected BroadcastReceiver mReceiver = new BroadcastReceiver() {
        @Override
        public void onReceive(Context context, Intent intent) {
            onProductConnectionChange();
        }
    };
~~~
The onReceive() method will be invoked when the DJI Product connection status change, we can use it to update our aircraft's location.
当 DJI 无人机连接状态发生变化时, 将调用 onReceive ()方法, 我们可以使用它来更新无人机的位置。

Next, let's implement the initFlightController() method and invoke it inside the onProductConnectionChange() method:
接下来, 让我们实现 initFlightController ()方法, 并在 onProductConnectionChange ()方法中调用它:
~~~
private void onProductConnectionChange()
{
    initFlightController();
}
 private void initFlightController() {
        BaseProduct product = DJIDemoApplication.getProductInstance();
        if (product != null && product.isConnected()) {
            if (product instanceof Aircraft) {
                mFlightController = ((Aircraft) product).getFlightController();
            }
        }
        if (mFlightController != null) {
            mFlightController.setStateCallback(
                    new FlightControllerState.Callback() {
                @Override
                public void onUpdate(FlightControllerState djiFlightControllerCurrentState) {
                    droneLocationLat = djiFlightControllerCurrentState.getAircraftLocation().getLatitude();
                    droneLocationLng = djiFlightControllerCurrentState.getAircraftLocation().getLongitude();
                    updateDroneLocation();
                }
            });
        }
    }
~~~
In the code above, we firstly check the product connection status with the help of isConnected() method of BaseProduct. Then initialize mFlightController variable and override the onUpdate() method to invoke updateDroneLocation method. By using the onUpdate() method, you can get the flight controller current state from the parameter.
在上面的代码中, 我们首先使用 BaseProduct 的 isConnected 方法检查无人机连接状态。 然后初始化 mFlightController 变量并重写 onUpdate 方法来调用 updateDroneLocation 方法。 使用 onUpdate ()方法, 可以从参数中获取飞控当前状态。

Furthermore, let's implement the updateDroneLocation() method and invoke it in onClick() method's locate button click action:
此外, 让我们实现 updateDroneLocation 方法, 并在location按钮点击事件的onClick ()方法中调用它:
~~~
public static boolean checkGpsCoordination(double latitude, double longitude) {
        return (latitude > -90 && latitude < 90 && longitude > -180 && longitude < 180) && (latitude != 0f && longitude != 0f);
}
    
private void updateDroneLocation(){
    LatLng pos = new LatLng(droneLocationLat, droneLocationLng);
    //Create MarkerOptions object
    final MarkerOptions markerOptions = new MarkerOptions();
    markerOptions.position(pos);
    markerOptions.icon(BitmapDescriptorFactory.fromResource(R.drawable.aircraft));
    runOnUiThread(new Runnable() {
        @Override
        public void run() {
            if (droneMarker != null) {
                droneMarker.remove();
            }
            if (checkGpsCoordinates(droneLocationLat, droneLocationLng)) {
                droneMarker = aMap.addMarker(markerOptions);
            }
        }
    });
}
@Override
public void onClick(View v) {
    // TODO Auto-generated method stub
    switch (v.getId()) {
        case R.id.locate:{
            updateDroneLocation();
            cameraUpdate();
            break;
        }
        case R.id.config:{
            showSettingDialog();
            break;
        }
        default:
            break;
    }
}
~~~
In the updateDroneLocation() method, we add the drone location marker on Gaode map.
在 updateDroneLocation 方法中, 我们添加了高德地图上的无人机位置Marker。

Finally, let's implement the camearUpdate() method to move camera and zoom in Gaode Map to the drone's location:
最后, 让我们实现 camearUpdate ()方法, 在当前MapView中移动和缩放到无人机的位置:
~~~
private void cameraUpdate(){
    LatLng pos = new LatLng(droneLocationLat, droneLocationLng);
    float zoomlevel = (float) 18.0;
    CameraUpdate cu = CameraUpdateFactory.newLatLngZoom(pos, zoomlevel);
    aMap.moveCamera(cu);
}

~~~
Before going forward, you can check the Using DJI Assistant 2 Simulator for its basic usage.
在这之前, 您可以检查使用 DJI 助手2模拟器的基本用法。

Now, let's connect the aircraft to your PC or Mac running DJI Assistant 2 via a Micro USB cable, and then power on the aircraft and the remote controller. Press the Simulator button in the DJI Assistant 2 and feel free to type in your current location's latitude and longitude data into the simulator.
现在, 让我们通过一个USB线将无人机连接到你的电脑,然后给无人机和遥控器开机。在 DJI 助手2中按下模拟器按钮, 然后在模拟器中随意输入当前位置的经纬度数据。
![](https://devcn.djicdn.com/images/tutorials-and-samples/Android/GSDemo-Gaode-Map/simulator_preview-773972d690.png)
simulatorPreview

Next, build and run the project and install it in your Android device and connect it to the remote controller using USB cable.
接下来, 建立并运行该项目并将其安装到你的手机中, 并使用 USB连接到遥控器。

Press the Start Simulating button. If you check the application now, a tiny red aircraft will be shown on the map. If you cannot find the aircraft, press the "LOCATE" button to zoom in to the center of the aircraft on the Map. Here is a gif animation for you to check:
按下启动模拟按钮。 如果你现在查看APP, 地图上会显示一个小小的红色无人机。 如果找不到无人机, 请按"LOCATE"按钮放大到地图上无人机的中心。 下面是一个 gif 动画, 你可以查看:
![](https://devcn.djicdn.com/images/tutorials-and-samples/Android/GSDemo-Gaode-Map/locateAircraft-164e600171.gif)
locateAircraft

####  **Adding Waypoint Markers<br>添加 Waypoint marker**
 
Since you can see the aircraft clearly on the Gaode map now, you can add Marker on the map to show the waypoints of the Waypoint Mission. Let's continue to declare the mMarkers variable first:
现在你可以在高德地图上看到无人机, 你也可以在地图上添加 Marker 来显示 Waypoint 任务的路线。 让我们先声明 mMarkers 变量:
~~~
private boolean isAdd = false;
private final Map<Integer, Marker> mMarkers = new ConcurrentHashMap<Integer, Marker>();
~~~
Then, implement the onMapClick() and markWaypoint() methods as shown below:
然后, 实现 onMapClick ()和 markWaypoint ()方法, 如下所示:
~~~
private void setResultToToast(final String string){
    MainActivity.this.runOnUiThread(new Runnable() {
        @Override
        public void run() {
            Toast.makeText(MainActivity.this, string, Toast.LENGTH_SHORT).show();
        }
    });
}
    
@Override
public void onMapClick(LatLng point) {
    if (isAdd == true){
        markWaypoint(point);       
    }else{
        setResultToToast("Cannot add waypoint");
    }
}
    
private void markWaypoint(LatLng point){
    //Create MarkerOptions object
    MarkerOptions markerOptions = new MarkerOptions();
    markerOptions.position(point);
  markerOptions.icon(BitmapDescriptorFactory.defaultMarker(BitmapDescriptorFactory.HUE_BLUE));
    Marker marker = aMap.addMarker(markerOptions);
    mMarkers.put(mMarkers.size(), marker);
}
~~~
Here, the onMapClick() method will be invoked when user tap on the Map View. When user tap on different position of the Map View, we will create a MarkerOptions object and assign the "LatLng" object to it, then invoke aMap's addMarker() method by passing the markerOptions parameter to add the waypoint markers on the Gaode map.
当用户点击地图时, onMapClick ()方法将被调用。 当用户点击地图的不同位置时, 我们将"LatLng"对象赋给MarkerOptions 数组对象,然后通过传递 MarkerOptions 参数，调用 aMap 的 addMarker ()方法, , 在高德地图上添加 waypoint markers。

Finally, let's implement the onClick() and enableDisableAdd() methods to implement the ADD and CLEAR actions as shown below:
最后, 让我们实现 onClick ()和 enableDisableAdd ()方法来实现添加和清除操作, 如下所示:
~~~
 @Override
 public void onClick(View v) {
    switch (v.getId()) {
        case R.id.add:{
            enableDisableAdd();
            break;
        }
        case R.id.clear:{
            runOnUiThread(new Runnable() {
                @Override
                public void run() {
                    aMap.clear();
                }
                updateDroneLocation();
            });
            break;
        }
        case R.id.config:{
            showSettingDialog();
            break;
        }
        default:
            break;
    }
}
    
private void enableDisableAdd(){
   if (isAdd == false) {
      isAdd = true;
      add.setText("Exit");
   }else{
      isAdd = false;
      add.setText("Add");
   }
 }
~~~
Now, let's try to build and run your application on an Android device and try to add waypoints on the Gaode map. If everything goes well, you should see the following gif animation:
在 Android 设备上构建和运行APP, 并在高德地图上添加 waypoints。 如果一切顺利, 你应该看看下面的 gif 动画:
![](https://devcn.djicdn.com/images/tutorials-and-samples/Android/GSDemo-Gaode-Map/addWaypointsAni-1ba7238445.gif)
addWaypointsAni

####  **Implementing Waypoint Missions<br>实现 waypoint missions**
 
 **Configurating Waypoint Mission<br>配置 Waypoint mission**

Before we upload a Waypoint Mission, we should provide a way for user to configure it, like setting the flying altitude, speed, heading, etc. So let's declare several variables as shown below firstly:
在我们上传 Waypoint 任务之前, 我们应该为用户提供设置选项, 比如飞行高度、速度、航向等等。 因此, 让我们先声明下面的几个变量:
~~~
private float altitude = 100.0f;
private float mSpeed = 10.0f;
private List<Waypoint> waypointList = new ArrayList<>();
public static WaypointMission.Builder waypointMissionBuilder;
private WaypointMissionOperator instance;
private WaypointMissionFinishedAction mFinishedAction = WaypointMissionFinishedAction.NO_ACTION;
private WaypointMissionHeadingMode mHeadingMode = WaypointMissionHeadingMode.AUTO;
~~~
Here we declare the altitude, mSpeed, mFinishedAction and mHeadingMode variable and intialize them with default value. Also, we declare the WaypointMission.Builder and WaypointMissionOperator variables for setting up missions.
这里我们声明altitude, mSpeed, mFinishedAction 和 mHeadingMode 变量, 并初始化它们。 此外, 我们声明 WaypointMission.Builder 和 WaypointMissionOperator 变量用于设置任务属性。

Next, replace the code of showSettingDialog() method with the followings:
接下来, 用以下方法代替 showSettingDialog 方法代码:
~~~
private void showSettingDialog(){
    LinearLayout wayPointSettings = (LinearLayout)getLayoutInflater().inflate(R.layout.dialog_waypointsetting, null);
    final TextView wpAltitude_TV = (TextView) wayPointSettings.findViewById(R.id.altitude);
    RadioGroup speed_RG = (RadioGroup) wayPointSettings.findViewById(R.id.speed);
    RadioGroup actionAfterFinished_RG = (RadioGroup) wayPointSettings.findViewById(R.id.actionAfterFinished);
    RadioGroup heading_RG = (RadioGroup) wayPointSettings.findViewById(R.id.heading);
    speed_RG.setOnCheckedChangeListener(new RadioGroup.OnCheckedChangeListener(){
        @Override
        public void onCheckedChanged(RadioGroup group, int checkedId) {
            if (checkedId == R.id.lowSpeed){
                mSpeed = 3.0f;
            } else if (checkedId == R.id.MidSpeed){
                mSpeed = 5.0f;
            } else if (checkedId == R.id.HighSpeed){
                mSpeed = 10.0f;
            }
        }
    });
    actionAfterFinished_RG.setOnCheckedChangeListener(new RadioGroup.OnCheckedChangeListener() {
        @Override
        public void onCheckedChanged(RadioGroup group, int checkedId) {
            Log.d(TAG, "Select finish action");
            if (checkedId == R.id.finishNone){
                mFinishedAction = WaypointMissionFinishedAction.NO_ACTION;
            } else if (checkedId == R.id.finishGoHome){
                mFinishedAction = WaypointMissionFinishedAction.GO_HOME;
            } else if (checkedId == R.id.finishAutoLanding){
                mFinishedAction = WaypointMissionFinishedAction.AUTO_LAND;
            } else if (checkedId == R.id.finishToFirst){
                mFinishedAction = WaypointMissionFinishedAction.GO_FIRST_WAYPOINT;
            }
        }
    });
    heading_RG.setOnCheckedChangeListener(new RadioGroup.OnCheckedChangeListener() {
        @Override
        public void onCheckedChanged(RadioGroup group, int checkedId) {
            Log.d(TAG, "Select heading");
            if (checkedId == R.id.headingNext) {
                mHeadingMode = WaypointMissionHeadingMode.AUTO;
            } else if (checkedId == R.id.headingInitDirec) {
                mHeadingMode = WaypointMissionHeadingMode.USING_INITIAL_DIRECTION;
            } else if (checkedId == R.id.headingRC) {
                mHeadingMode = WaypointMissionHeadingMode.CONTROL_BY_REMOTE_CONTROLLER;
            } else if (checkedId == R.id.headingWP) {
                mHeadingMode = WaypointMissionHeadingMode.USING_WAYPOINT_HEADING;
            }
        }
    });
    new AlertDialog.Builder(this)
            .setTitle("")
            .setView(wayPointSettings)
            .setPositiveButton("Finish",new DialogInterface.OnClickListener(){
                public void onClick(DialogInterface dialog, int id) {
                    String altitudeString = wpAltitude_TV.getText().toString();
                    altitude = Integer.parseInt(nulltoIntegerDefalt(altitudeString));
                    Log.e(TAG,"altitude "+altitude);
                    Log.e(TAG,"speed "+mSpeed);
                    Log.e(TAG, "mFinishedAction "+mFinishedAction);
                    Log.e(TAG, "mHeadingMode "+mHeadingMode);
                    configWayPointMission();
                }
            })
            .setNegativeButton("Cancel", new DialogInterface.OnClickListener() {
                public void onClick(DialogInterface dialog, int id) {
                    dialog.cancel();
                }
            })
            .create()
            .show();
}
String nulltoIntegerDefault(String value){
    if(!isIntValue(value)) value="0";
    return value;
}
boolean isIntValue(String val)
{
    try {
        val=val.replace(" ","");
        Integer.parseInt(val);
    } catch (Exception e) {return false;}
    return true;
}
~~~
Here, we implement the setOnCheckedChangeListener() method of "RadioGroup" class and pass different values to the mSpeed, mFinishedAction and mHeadingMode variables based on the item user select.
在这里, 我们实现 radioGroup 类的 setOnCheckedChangeListener 方法, 当用户选择后将不同的值传递给 mSpeed、 mFinishedAction 和 mHeadingMode 变量。

For the finished action of DJIWaypointMission, we provide several enum values here:
对于已经完成的 DJIWaypointMission 操作, 我们在这里提供了几个values值:

AUTO_LAND
自动降落

The aircraft will land automatically at the last waypoint.
无人机将在最后一个waypoint自动降落。

CONTINUE_UNTIL_END
继续直到结束

If the user attempts to pull the aircraft back along the flight path as the mission is being executed, the aircarft will move towards the previous waypoint and will continue to do so until there are no more waypoint to move back to or the user has stopped attempting to move the aircraft back.

GO_FIRST_WAYPOINT
回到第一个waypoint

The aircraft will go back to its first waypoint and hover in position.
无人机将回到它的第一个waypoint, 并悬停在位置上。

GO_HOME
返航

The aicraft will go home when the mission is complete.
任务完成后, 无人机就会返航。

NO_ACTION
原地悬停

No further action will be taken on completion of mission.
任务完成后原地悬停。

For the heading mode of DJIWaypointMission, we provide these enum values here:
对于"DJIWaypointMission"的机头朝向, 我们在这里提供这些 enum 值:

AUTO
自动

Aircraft's heading will always be in the direction of flight.
航向锁定

CONTROL_BY_REMOTE_CONTROLLER
遥控器控制模式

Aircraft's heading will be controlled by the remote controller.
无人机的机头由遥控器控制。

TOWARD_POINT_OF_INTEREST
机头朝向兴趣点

Aircraft's heading will always toward point of interest.
无人机的机头总是朝着任务的前进方向。

USING_INITIAL_DIRECTION
使用初始方向

Aircraft's heading will be set to the initial take-off heading.
无人机的机头将被设定为起飞的最初机头方向。

USING_WAYPOINT_HEADING
使用 waypoint机头方向

Aircraft's heading will be set to the previous waypoint's heading while travelling between waypoints.
无人机的机头将被设置为前一个航点的机头方向,同时在两个航线点之间飞行。

Now, let's continue to implement the getWaypointMissionOperator() and configWayPointMission() methods as shown below:
现在, 让我们继续实现 getwaypointoperatoroperator ()和 config waypointmission ()方法, 如下所示:
~~~
public WaypointMissionOperator getWaypointMissionOperator() {
    if (instance == null) {
        instance = DJISDKManager.getInstance().getMissionControl().getWaypointMissionOperator();
    }
    return instance;
}
private void configWayPointMission(){
    if (waypointMissionBuilder == null){
        waypointMissionBuilder = new WaypointMission.Builder().finishedAction(mFinishedAction)
                                                              .headingMode(mHeadingMode)
                                                              .autoFlightSpeed(mSpeed)
                                                              .maxFlightSpeed(mSpeed)
                                                              .flightPathMode(WaypointMissionFlightPathMode.NORMAL);
    }else
    {
        waypointMissionBuilder.finishedAction(mFinishedAction)
                .headingMode(mHeadingMode)
                .autoFlightSpeed(mSpeed)
                .maxFlightSpeed(mSpeed)
                .flightPathMode(WaypointMissionFlightPathMode.NORMAL);
    }
    if (waypointMissionBuilder.getWaypointList().size() > 0){
        for (int i=0; i< waypointMissionBuilder.getWaypointList().size(); i++){
            waypointMissionBuilder.getWaypointList().get(i).altitude = altitude;
        }
        setResultToToast("Set Waypoint attitude successfully");
    }
    DJIError error = getWaypointMissionOperator().loadMission(waypointMissionBuilder.build());
    if (error == null) {
        setResultToToast("loadWaypoint succeeded");
    } else {
        setResultToToast("loadWaypoint failed " + error.getDescription());
    }
}
~~~
In the code above, we firstly get the WaypointMissionOperator instance in the getWaypointMissionOperator() method, then in the configWayPointMission() method, we check if waypointMissionBuilder is null and set its finishedAction, headingMode, autoFlightSpeed, maxFlightSpeed and flightPathMode variables of WaypointMission.Builder. Then we use a for loop to set each DJIWaypoint's altitude in the waypointMissionBuilder's waypointsList. Next, we invoke the loadMission() method of WaypointMissionOperator and pass the waypointMissionBuilder.build() as its parameter to load the waypoint mission to the operator.
在上面的代码中, 我们首先在 getWaypointMissionOperator()方法中获取 WaypointMissionOperator实例, 然后在 configWayPointMission ()方法中, 检查 waypointMissionBuilder 是否为空, 并设置 finishedaction后续动作, headingMode机头模式, autoFlightSpeed自动飞行速度, maxFlightSpeed最大飞行速度 和 flightPathMode飞行路径模式 变量。 然后,在wayponitMissionBuilder的waypointsList中我们使用 for 循环设置每个DJIWaypoint的高度。接下来,我们传入waypointMissionBuilder.build()作为参数调用 WaypointMissionOperator的 loadMission ()方法,加载waypoint 任务。

 **Upload Waypoint Mission<br>上传 Waypoint 任务**
 
Now, let's create the following methods to setup WaypointMissionOperatorListener:
现在, 让我们创建下面的方法来设置 WaypointMissionOperatorListener:
~~~
@Override
protected void onCreate(Bundle savedInstanceState) {
   ...
   addListener();
   
}
@Override
protected void onDestroy(){
    ...
    removeListener();
}
//Add Listener for WaypointMissionOperator
private void addListener() {
    if (getWaypointMissionOperator() != null) {
        getWaypointMissionOperator().addListener(eventNotificationListener);
    }
}
private void removeListener() {
    if (getWaypointMissionOperator() != null) {
        getWaypointMissionOperator().removeListener(eventNotificationListener);
    }
}
private WaypointMissionOperatorListener eventNotificationListener = new WaypointMissionOperatorListener() {
    @Override
    public void onDownloadUpdate(WaypointMissionDownloadEvent downloadEvent) {
    }
    @Override
    public void onUploadUpdate(WaypointMissionUploadEvent uploadEvent) {
    }
    @Override
    public void onExecutionUpdate(WaypointMissionExecutionEvent executionEvent) {
    }
    @Override
    public void onExecutionStart() {
    }
    @Override
    public void onExecutionFinish(@Nullable final DJIError error) {
        setResultToToast("Execution finished: " + (error == null ? "Success!" : error.getDescription()));
    }
};
~~~
In the code above, we invoke the addListener() and removeListener() methods of WaypointMissionOperator to add and remove the WaypointMissionOperatorListener and then invoke the addListener() method at the bottom of onCreate() method and invoke the removeListener() method in the onDestroy() method.
在上面的代码中, 我们调用WaypointMissionOperator的 addListener ()和 removeListener 方法来添加和删除 WaypointMissionOperatorListener, 然后在 onCreate ()方法的底部调用 addListener ()方法, 并在 onDestroy ()方法中调用 removeListener ()方法。

Next, initialize the WaypointMissionOperatorListener instance and implement its onExecutionFinish() method to show a message to inform user when the mission execution finished.
接下来, 初始化 WaypointMissionOperatorListener 实例并实现其 onExecutionFinish ()方法, 以便在任务执行完成时通过显示消息通知用户。

Furthermore, let's set waypointList of WaypointMission.Builder when user tap on the map to add a waypoint in the onMapClick() method and implement the uploadWayPointMission() method to upload mission to the operator as shown below:
此外,当用户点击地图, 在 onMapClick ()方法中添加一个 waypoint 点, 同时实现 uploadWayPointMission ()方法, 然后设置 WaypointMission.Builder 的 waypointList,最后实现上传任务操作, 如下所示:
~~~
@Override
public void onMapClick(LatLng point) {
    if (isAdd == true){
        markWaypoint(point);
        Waypoint mWaypoint = new Waypoint(point.latitude, point.longitude, altitude);
        //Add Waypoints to Waypoint arraylist;
        if (waypointMissionBuilder != null) {
            waypointList.add(mWaypoint);
            waypointMissionBuilder.waypointList(waypointList).waypointCount(waypointList.size());
        }else
        {
            waypointMissionBuilder = new WaypointMission.Builder();
            waypointList.add(mWaypoint);
            waypointMissionBuilder.waypointList(waypointList).waypointCount(waypointList.size());
        }
    }else{
        setResultToToast("Cannot Add Waypoint");
    }
}
private void uploadWayPointMission(){
    getWaypointMissionOperator().uploadMission(new CommonCallbacks.CompletionCallback() {
        @Override
        public void onResult(DJIError error) {
            if (error == null) {
                setResultToToast("Mission upload successfully!");
            } else {
                setResultToToast("Mission upload failed, error: " + error.getDescription() + " retrying...");
                getWaypointMissionOperator().retryUploadMission(null);
            }
        }
    });
}
~~~
Lastly, let's add the R.id.upload case checking in the onClick() method:
最后, 让我们在 onClick ()方法中添加 R.id.upload选项:
~~~
case R.id.upload:{
    uploadWayPointMission();
    break;
}
~~~
 **Start and Stop Mission<br>开始和停止任务**
 
Once the mission finish uploading, we can invoke the startMission() and stopMission() methods of WaypointMissionOperator to implement the start and stop mission features as shown below:
一旦任务上传完成,调用 WaypointMissionOperator的 startMission ()和 stopMission ()方法来实现下面所示的开始和停止任务方法
~~~
private void startWaypointMission(){
    getWaypointMissionOperator().startMission(new CommonCallbacks.CompletionCallback() {
        @Override
        public void onResult(DJIError error) {
            setResultToToast("Mission Start: " + (error == null ? "Successfully" : error.getDescription()));
        }
    });
}
private void stopWaypointMission(){
    getWaypointMissionOperator().stopMission(new CommonCallbacks.CompletionCallback() {
        @Override
        public void onResult(DJIError error) {
            setResultToToast("Mission Stop: " + (error == null ? "Successfully" : error.getDescription()));
        }
    });
}

~~~
Lastly, let's improve the onClick() method to improve the clear button action and implement the start and stop button actions:
最后, 让我们实现 onClick ()方法, 以实现清除按钮的操作, 并实现开始和停止按钮的功能:
~~~
@Override
public void onClick(View v) {
    switch (v.getId()) {
        case R.id.locate:{
            updateDroneLocation();
            cameraUpdate(); // Locate the drone's place
            break;
        }
        case R.id.add:{
            enableDisableAdd();
            break;
        }
        case R.id.clear: {
            runOnUiThread(new Runnable() {
                @Override
                public void run() {
                    aMap.clear();
                }
            });
            waypointList.clear();
            waypointMissionBuilder.waypointList(waypointList);
            updateDroneLocation();
            break;
        }
        case R.id.config:{
            showSettingDialog();
            break;
        }
        case R.id.upload:{
            uploadWayPointMission();
            break;
        }
        case R.id.start:{
            startWaypointMission();
            break;
        }
        case R.id.stop:{
            stopWaypointMission();
            break;
        }
        default:
            break;
    }
}
~~~
 ### **Test Waypoint Mission with DJI Assistant 2 Simulator<br>在DJI 助手2模拟器中测试 Waypoint 任务**
 
* * * * *

You've come a long way in this tutorial, and it's time to test the whole application.
在这个教程中你已经取得了很大的进步, 开始测试整个APP了。

Important: Make sure the battery level of your aircraft is more than 10%, otherwise the waypoint mission may fail!
重要的: 确保你的无人机的电池水平超过10% , 否则航点任务可能会失败！

Build and run the project to install the application into your android device. After that, please connect the aircraft to your PC or Mac running DJI Assistant 2 Simulator via a Micro USB cable. Then, power on the remote controller and the aircraft, in that order.
构建并运行项目, 将APP安装到手机中。通过 USB 线将无人机连接到您的电脑或运行 DJI 助手2模拟器。然后, 依次给遥控器和无人机上电。

Next, press the Simulator button in the DJI Assistant 2 and feel free to type in your current location's latitude and longitude data into the simulator.
接下来, 在 DJI 助手2中按下模拟器按钮, 然后在模拟器中随意输入当前位置的经纬度数据。
![](https://devcn.djicdn.com/images/tutorials-and-samples/Android/GSDemo-Gaode-Map/simulator_preview-773972d690.png)
simulatorPreview

Then connect your android device to the remote controller using USB cable and run the application. Go back to the DJI Assistant 2 Simulator on your PC or Mac and press the Start Simulating button. A tiny red aircraft will appear on the map in your application, if you press the LOCATE button, the map view will zoom in to the region you are in and will center the aircraft:
然后使用 USB 线将手机连接到遥控器上, 运行APP。在电脑上的 DJI 助手2模拟器上按下启动模拟按钮。在APP中, 一个红色无人机将出现在地图上, 如果你按下定位按钮, 地图将会放大到你所在的区域, 并将无人机显示在中心:
![](https://devcn.djicdn.com/images/tutorials-and-samples/Android/GSDemo-Gaode-Map/locateAircraft-164e600171.gif)
locateAircraft

Next, press the Add button and tap on the Map where you want to add waypoints, as shown below:
接下来, 按下添加按钮, 点击地图上要添加的WayPoint,如下图所示:
![](https://devcn.djicdn.com/images/tutorials-and-samples/Android/GSDemo-Gaode-Map/addWaypointsAni-1ba7238445.gif)
addWaypointsAni

Once you press the CONFIG button, the Waypoint Configuration dialog will appear. Modify the settings as you want and press Finish button. Then press the UPLOAD button to upload the mission.
一旦你按下配置按钮, 就会出现 Waypoint 配置对话框。 修改设置, 然后按"完成"按钮。 然后按下 上传 按钮上传任务。

If upload mission success, press the START button to start the waypoint mission execution.
如果上传任务成功, 请按启动按钮 启动  waypoint 任务。
![](https://devcn.djicdn.com/images/tutorials-and-samples/Android/GSDemo-Gaode-Map/prepareMission-68e0a3496d.gif)
prepareMission

Now you should see the aircraft move towards the waypoints you set previously on the map view, as shown below:
现在你应该看到无人机朝着你之前在地图中设置的航点移动, 如下图所示:
![](https://devcn.djicdn.com/images/tutorials-and-samples/Android/GSDemo-Gaode-Map/startMission-42453b5954.gif)
startMission

At the same time, you are able to see the Mavic Pro take off and start to fly in the DJI Assistant 2 Simulator.
同时, 您可以看到 Mavic Pro 在 DJI 助手2模拟器上起飞并开始飞行。
![](https://devcn.djicdn.com/images/tutorials-and-samples/Android/GSDemo-Gaode-Map/takeOff-4c35600d3c.gif)
flyingInSimulator

When the waypoint mission finishes, an "Execution finished: Success!" message will appear and the Mavic Pro will start to go home!
当 waypoint 任务结束时, 一个"执行完成: 成功!" 信息将会出现, Mavic Pro 将开始返航！

Also, the remote controller will start beeping. Let's take a look at the DJI Assistant 2 Simulator now:
另外, 遥控器也会开始发出哔哔声。 让我们来看看 DJI 助手2模拟器:
![](https://devcn.djicdn.com/images/tutorials-and-samples/Android/GSDemo-Gaode-Map/landing-85761035a6.gif)
landing

The Mavic Pro will eventually go home, land, and the beeping from the remote controller will stop. The application will go back to its normal status. If you press the CLEAR button, all the waypoints you previously set will be cleared. During the mission, if you'd ever like to stop the DJIWaypoint mission, you can do so by pressing the STOP button.
最终, Mavic Pro 会返航, 降落, 遥控器的哔哔声就会停止。APP将回到正常状态。如果你按下 CLEAR 按钮, 你之前设置的所有任务点都将被清除。在任务期间, 如果您想要停止WayPonit任务, 你可以按下 STOP 按钮。

###  **Summary<br>摘要**
In this tutorial, you’ve learned how to setup and use the DJI Assistant 2 Simulator to test your waypoint mission application, upgrade your aircraft's firmware to the developer version, use the DJI Mobile SDK to create a simple map view, modify annotations of the map view, show the aircraft on the map view by using GPS data from the DJI Assistant 2 Simulator. Next, you learned how to use the WaypointMission.Builder to configure waypoint mission settings, how to create and set the waypointList in the WaypointMission.Builder. Moreover, you learned how to use WaypointMissionOperator to upload, start and stop missions.
在本教程中, 您已经学习了如何安装和使用 DJI 助手2模拟器来测试你的 waypoint Mission APP, 升级您的无人机固件到最新版本, 首先使用 DJI Mobile SDK 创建一个简单的地图,修改地图视图, 通过修改 DJI 助手2模拟器的 GPS 数据将无人机显示在地图中。接下来, **学习了如何使用 WaypointMission.Builder 来配置 waypoint 任务设置**, **如何在 waypoint.builder 中创建和设置 waypointList**。此外, 您还**学习了如何使用 WaypointMissionOperator 上传、启动和停止任务**。

Congratulations! Now that you've finished the demo project, you can build on what you've learned and start to build your own waypoint mission application. You can improve the method which waypoints are added(such as drawing a line on the map and generating waypoints automatically), play around with the properties of a waypoint (such as heading, etc.), and adding more functionality. In order to make a cool waypoint mission application, you still have a long way to go. Good luck and hope you enjoy this tutorial!
恭喜你！现在你已经完成了示例项目, 你可以在你已经学到的东西的基础上, 开始构建自己的 waypoint Mission APP。 您可以改进添加 waypoints 的方法(例如在地图上画一条线, 自动生成航点) , 使用 waypoint 的属性(如标题等) , 并添加更多的功能。 为了制作一个很酷的 waypoint Mission APP, 你还有很长的路要走。希望你喜欢这个教程！


如果您觉得文档翻译有不妥，欢迎到Github上发起push请求，
如果你觉得本文档对您有帮助，可以通过赞赏来帮助我持续维护文档
也可以扫描下面的二维码加我微信拉您进DJI Mobile SDK 开发者群 探讨DJI SDK开发相关问题
![](images/20180303_092058.jpg)